{{ define "content" }}
<div class="row">
  <div class="span12">
    <h2>Reconciliation Results - {{.bankAccount}}</h2>
    
    <div class="alert alert-info">
      <h4>Summary</h4>
      <div class="row">
        <div class="span6">
          <p><strong>Period:</strong> {{.result.DateRange}}</p>
          <p><strong>Currency:</strong> {{.result.BankStatement.Currency}}</p>
          <p><strong>Bank Transactions:</strong> {{len .result.BankStatement.Transactions}}</p>
          {{ if gt (len .result.BankStatement.Transactions) 0 }}
          <p><strong>Matched:</strong> {{len .result.Matches}} ({{printf "%.0f" (div (mul (len .result.Matches | float64) 100.0) (len .result.BankStatement.Transactions | float64))}}%)</p>
          {{ else }}
          <p><strong>Matched:</strong> {{len .result.Matches}} (0%)</p>
          {{ end }}
          <p><strong>Unmatched:</strong> <span class="label label-warning">{{len .result.UnmatchedBank}}</span></p>
        </div>
        <div class="span6">
          <p><strong>Bank Debits:</strong> {{.result.BankStatement.Currency}}{{printf "%.2f" .result.TotalBankDebits}}</p>
          <p><strong>Bank Credits:</strong> {{.result.BankStatement.Currency}}{{printf "%.2f" .result.TotalBankCredits}}</p>
          <p><strong>Net Change:</strong> {{.result.BankStatement.Currency}}{{printf "%.2f" (sub .result.TotalBankCredits .result.TotalBankDebits)}}</p>
        </div>
      </div>
    </div>
    
    <h3>Bank Statement Transactions</h3>
    <p><span class="label label-warning">Highlighted rows</span> are not found in your ledger file.</p>
    
    <table class="table table-condensed">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Debit</th>
          <th>Credit</th>
          <th>Net</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {{ range .result.AllBankTransactions }}
        <tr class="{{if not .Matched}}warning{{end}}" style="{{if not .Matched}}background-color: #fcf8e3;{{end}}">
          <td>{{.Transaction.Date.Format "2006-01-02"}}</td>
          <td>
            {{.Transaction.Description}}
            {{if .Transaction.Reference}}<br><small class="muted">{{.Transaction.Reference}}</small>{{end}}
          </td>
          <td>{{if gt .Transaction.Debit 0.0}}{{.Transaction.Currency}}{{printf "%.2f" .Transaction.Debit}}{{end}}</td>
          <td>{{if gt .Transaction.Credit 0.0}}{{.Transaction.Currency}}{{printf "%.2f" .Transaction.Credit}}{{end}}</td>
          <td><strong>{{.Transaction.Currency}}{{printf "%.2f" (sub .Transaction.Credit .Transaction.Debit)}}</strong></td>
          <td>
            {{ if not .Matched }}
              <span class="label label-warning">Not in ledger</span>
            {{ else if eq .MatchType "exact" }}
              <span class="label label-success">Matched</span>
            {{ else }}
              <span class="label label-success">Fuzzy ({{printf "%.0f" (mul .MatchScore 100)}}%)</span>
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
    
    {{ if .result.UnmatchedLedger }}
    <div class="alert alert-error">
      <h4><i class="icon-warning-sign"></i> Ledger Transactions Not in Bank Statement ({{len .result.UnmatchedLedger}})</h4>
      <p>These transactions appear in your ledger but not in the bank statement for this period:</p>
      
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          {{ range .result.UnmatchedLedger }}
          <tr>
            <td>{{.Date.Format "2006-01-02"}}</td>
            <td><strong>{{$.result.BankStatement.Currency}}{{printf "%.2f" .Amount}}</strong></td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
    
    {{ if .suggestedEntries }}
    <div class="well">
      <h4>Suggested Ledger Entries</h4>
      <p>Copy these entries to add the unmatched bank transactions to your ledger:</p>
      <pre class="template" style="display: block; max-height: 400px; overflow: auto;">{{ range .suggestedEntries }}{{.}}
{{ end }}</pre>
      <button class="btn btn-small" onclick="copyToClipboard()">Copy to Clipboard</button>
    </div>
    {{ end }}
    
    <hr>
    <a href="{{.root}}/{{.ledger}}/reconcile" class="btn">Reconcile Another Statement</a>
    <a href="{{.root}}/{{.ledger}}" class="btn btn-primary">Back to Ledger</a>
  </div>
</div>

<script>
function copyToClipboard() {
  var text = document.querySelector('.template').textContent;
  navigator.clipboard.writeText(text).then(function() {
    alert('Copied to clipboard!');
  }, function(err) {
    alert('Failed to copy: ' + err);
  });
}
</script>
{{ end }}
