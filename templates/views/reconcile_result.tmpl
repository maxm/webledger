{{ define "content" }}
<div class="row">
  <div class="span12">
    <h2>Reconciliation Results - {{.bankAccount}}</h2>
    
    <div class="alert alert-success">
      <h4>Summary</h4>
      <div class="row">
        <div class="span6">
          <p><strong>Period:</strong> {{.result.DateRange}}</p>
          <p><strong>Bank Transactions:</strong> {{len .result.BankStatement.Transactions}}</p>
          <p><strong>Matched:</strong> {{len .result.Matches}} ({{printf "%.0f" (div (mul (len .result.Matches) 100.0) (len .result.BankStatement.Transactions))}}%)</p>
        </div>
        <div class="span6">
          <p><strong>Bank Debits:</strong> {{printf "$%.2f" .result.TotalBankDebits}}</p>
          <p><strong>Bank Credits:</strong> {{printf "$%.2f" .result.TotalBankCredits}}</p>
          <p><strong>Net Change:</strong> {{printf "$%.2f" (sub .result.TotalBankCredits .result.TotalBankDebits)}}</p>
        </div>
      </div>
    </div>
    
    {{ if .result.UnmatchedBank }}
    <div class="alert alert-warning">
      <h4><i class="icon-warning-sign"></i> Unmatched Bank Transactions ({{len .result.UnmatchedBank}})</h4>
      <p>These transactions appear in your bank statement but not in your ledger:</p>
      
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Debit</th>
            <th>Credit</th>
            <th>Net</th>
          </tr>
        </thead>
        <tbody>
          {{ range .result.UnmatchedBank }}
          <tr>
            <td>{{.Date.Format "2006-01-02"}}</td>
            <td>{{.Description}}</td>
            <td>{{if gt .Debit 0}}{{printf "$%.2f" .Debit}}{{end}}</td>
            <td>{{if gt .Credit 0}}{{printf "$%.2f" .Credit}}{{end}}</td>
            <td><strong>{{printf "$%.2f" (sub .Credit .Debit)}}</strong></td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
    
    {{ if .result.UnmatchedLedger }}
    <div class="alert alert-error">
      <h4><i class="icon-warning-sign"></i> Unmatched Ledger Transactions ({{len .result.UnmatchedLedger}})</h4>
      <p>These transactions appear in your ledger but not in the bank statement:</p>
      
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Line</th>
          </tr>
        </thead>
        <tbody>
          {{ range .result.UnmatchedLedger }}
          <tr>
            <td>{{.Date.Format "2006-01-02"}}</td>
            <td>{{.Description}}</td>
            <td><strong>{{printf "$%.2f" .Amount}}</strong></td>
            <td>Line {{.LineNumber}}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    {{ end }}
    
    {{ if .suggestedEntries }}
    <div class="well">
      <h4>Suggested Ledger Entries</h4>
      <p>Copy these entries to add the unmatched bank transactions to your ledger:</p>
      <pre class="template" style="display: block; max-height: 400px; overflow: auto;">{{ range .suggestedEntries }}{{.}}
{{ end }}</pre>
      <button class="btn btn-small" onclick="copyToClipboard()">Copy to Clipboard</button>
    </div>
    {{ end }}
    
    {{ if .result.Matches }}
    <h3>Matched Transactions ({{len .result.Matches}})</h3>
    <table class="table table-striped table-condensed">
      <thead>
        <tr>
          <th>Date</th>
          <th>Bank Description</th>
          <th>Ledger Description</th>
          <th>Amount</th>
          <th>Match</th>
        </tr>
      </thead>
      <tbody>
        {{ range .result.Matches }}
        <tr class="{{if eq .MatchType "exact"}}success{{else}}warning{{end}}">
          <td>
            {{.BankTransaction.Date.Format "2006-01-02"}}<br>
            <small>{{.LedgerTransaction.Date.Format "2006-01-02"}}</small>
          </td>
          <td>{{.BankTransaction.Description}}</td>
          <td>{{.LedgerTransaction.Description}}</td>
          <td>{{printf "$%.2f" (sub .BankTransaction.Credit .BankTransaction.Debit)}}</td>
          <td>
            {{ if eq .MatchType "exact" }}
              <span class="label label-success">Exact</span>
            {{ else }}
              <span class="label label-warning">Fuzzy ({{printf "%.0f" (mul .MatchScore 100)}}%)</span>
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
    {{ end }}
    
    <hr>
    <a href="{{.root}}/{{.ledger}}/reconcile" class="btn">Reconcile Another Statement</a>
    <a href="{{.root}}/{{.ledger}}" class="btn btn-primary">Back to Ledger</a>
  </div>
</div>

<script>
function copyToClipboard() {
  var text = document.querySelector('.template').textContent;
  navigator.clipboard.writeText(text).then(function() {
    alert('Copied to clipboard!');
  }, function(err) {
    alert('Failed to copy: ' + err);
  });
}
</script>
{{ end }}
